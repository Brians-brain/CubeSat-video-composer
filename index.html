<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SATORO Shorts åˆæˆå™¨ (V10 æµæ°´ç·šç‰ˆ)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #121212; color: #e0e0e0; }
        h1 { text-align: center; color: #fff; letter-spacing: 1px; }
        .container { background: #1e1e1e; border-radius: 12px; padding: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.6); text-align: center; margin-top: 20px; border: 1px solid #333; }
        
        .file-upload-wrapper { border: 2px dashed #444; padding: 25px; border-radius: 10px; margin-top: 10px; transition: all 0.3s; background: #252525; }
        .file-upload-wrapper:hover { border-color: #E1306C; background: #2a2a2a; }
        input[type="file"] { display: none; }
        .custom-file-upload { display: inline-block; padding: 12px 25px; cursor: pointer; background: linear-gradient(45deg, #E1306C, #C13584); color: white; border-radius: 30px; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(225, 48, 108, 0.4); }
        #file-name-display { margin-top: 15px; color: #888; font-size: 14px; min-height: 20px; word-break: break-all; }

        input[type="text"] { padding: 12px; width: 80%; font-size: 16px; border: 1px solid #444; border-radius: 8px; margin-top: 5px; background: #2d2d2d; color: white; text-align: center; }
        
        button { margin-top: 30px; padding: 15px 40px; font-size: 20px; cursor: pointer; background-color: #009688; color: white; border: none; border-radius: 50px; transition: transform 0.2s; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 150, 136, 0.4); }
        button:disabled { background-color: #555; cursor: not-allowed; box-shadow: none; transform: none; }
        
        .progress-wrapper { width: 100%; background-color: #333; border-radius: 10px; margin-top: 25px; display: none; overflow: hidden; height: 28px; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #E1306C, #F77737); text-align: center; line-height: 28px; color: white; font-size: 14px; transition: width 0.3s; font-weight: bold; }
        
        #log { margin-top: 25px; font-family: 'Consolas', monospace; color: #bbb; background: #000; padding: 15px; border-radius: 8px; text-align: left; max-height: 300px; overflow-y: auto; font-size: 13px; border: 1px solid #333; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ“± SATORO Shorts åˆæˆå™¨ (V10)</h1>
    <p style="text-align:center; font-size: 14px; color: #888;">ç³»çµ±ç‹€æ…‹ï¼š<span id="system-status">æ­£åœ¨è¼‰å…¥å¼•æ“...</span></p>

    <div class="container">
        <h3 style="margin-bottom: 5px;">1. é¸æ“‡æ‚¨çš„è¡›æ˜Ÿå½±ç‰‡</h3>
        <div class="file-upload-wrapper">
            <label for="upload-video" class="custom-file-upload">ğŸ“‚ é»æ“Šé¸æ“‡å½±ç‰‡æª”æ¡ˆ</label>
            <input type="file" id="upload-video" accept="video/mp4,video/mov">
            <div id="file-name-display">å°šæœªé¸æ“‡æª”æ¡ˆ</div>
        </div>
        
        <br>
        
        <h3>2. è¨­å®šè¼¸å‡ºæª”å</h3>
        <input type="text" id="filename" value="SATORO_Mission.mp4">
        
        <br>
        
        <button id="start-btn" disabled>ğŸš€ é–‹å§‹åˆæˆ Shorts</button>
        
        <div class="progress-wrapper" id="progress-container">
            <div id="progress-bar">æº–å‚™ä¸­...</div>
        </div>
        
        <div id="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        // â˜… è«‹ç¢ºèª Repo ç¶²å€æ­£ç¢º
        const BASE_ASSETS_URL = 'https://brians-brain.github.io/CubeSat-video-composer/assets/';

        const statusSpan = document.getElementById('system-status');
        const startBtn = document.getElementById('start-btn');
        const logDiv = document.getElementById('log');
        const progressBar = document.getElementById('progress-bar');
        const fileInput = document.getElementById('upload-video');
        const fileNameDisplay = document.getElementById('file-name-display');

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.innerText = "âœ… å·²æº–å‚™å°±ç·’: " + fileInput.files[0].name;
                fileNameDisplay.style.color = "#4caf50";
                fileNameDisplay.style.fontWeight = "bold";
            }
        });

        function log(message) {
            logDiv.innerHTML += `<div>> ${typeof message === 'object' ? JSON.stringify(message) : message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        (async () => {
            try {
                await ffmpeg.load();
                statusSpan.innerHTML = "âœ… å¼•æ“æº–å‚™å°±ç·’";
                statusSpan.style.color = "#4caf50";
                startBtn.disabled = false;
                log("ç³»çµ±å°±ç·’ï¼Œè«‹é¸æ“‡å½±ç‰‡ã€‚");
            } catch (err) {
                statusSpan.innerHTML = "âŒ è¼‰å…¥å¤±æ•— (è«‹ç¢ºèª coi-serviceworker)";
                statusSpan.style.color = "#ff5252";
            }
        })();

        // é€šç”¨çš„è½‰æª”æŒ‡ä»¤ï¼šç¸®æ”¾ + è½‰30fps + å»éŸ³è»Œ
        // ä½¿ç”¨ -an æŒ‡ä»¤ç§»é™¤éŸ³è»Œï¼Œé¿å…å› ç‚ºè²éŸ³å°è‡´çš„ concat å¤±æ•—
        const processVideo = async (inputName, outputName, desc) => {
            log(`æ­£åœ¨è™•ç† ${desc}...`);
            progressBar.innerText = `è™•ç†ä¸­: ${desc}`;
            
            // é€™è£¡æˆ‘å€‘æŠŠè¤‡é›œçš„ filter æ‹†é–‹
            // scale: ç¸®æ”¾
            // pad: è£œé»‘é‚Š
            // setsar: ä¿®æ­£åƒç´ æ¯”
            // fps: çµ±ä¸€å¹€ç‡
            await ffmpeg.run(
                '-i', inputName,
                '-vf', 'scale=1080:1350:force_original_aspect_ratio=decrease,pad=1080:1350:(ow-iw)/2:(oh-ih)/2,setsar=1,fps=30,format=yuv420p',
                '-an', // â˜…é—œéµï¼šç§»é™¤éŸ³è»Œ (Remove Audio)
                '-c:v', 'libx264',
                '-preset', 'ultrafast',
                outputName
            );
            
            // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦ç”Ÿæˆ
            const files = ffmpeg.FS('readdir', '/');
            if (!files.includes(outputName)) {
                throw new Error(`${desc} è½‰æª”å¤±æ•—ï¼Œç„¡æ³•ç”Ÿæˆ ${outputName}`);
            }
            log(`âœ… ${desc} è™•ç†å®Œæˆï¼`);
        };

        startBtn.addEventListener('click', async () => {
            if (fileInput.files.length === 0) { alert("è«‹å…ˆé¸æ“‡å½±ç‰‡ï¼"); return; }

            startBtn.disabled = true;
            document.getElementById('progress-container').style.display = 'block';
            logDiv.innerHTML = "<div>--- é–‹å§‹ V10 æµæ°´ç·šä»»å‹™ ---</div>";

            try {
                // 0. ä¸‹è¼‰èˆ‡è®€å–
                log("æ­¥é©Ÿ 0: è®€å–ç´ æ...");
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(fileInput.files[0]));
                const ts = new Date().getTime();
                ffmpeg.FS('writeFile', 'intro.mp4', await fetchFile(BASE_ASSETS_URL + 'intro.mp4?t=' + ts));
                ffmpeg.FS('writeFile', 'outro.mp4', await fetchFile(BASE_ASSETS_URL + 'outro.mp4?t=' + ts));

                // 1. è™•ç†å‰å°ç‰‡
                await processVideo('intro.mp4', 'safe_1.mp4', 'å‰å°ç‰‡');

                // 2. è™•ç†è¡›æ˜Ÿå½±ç‰‡
                await processVideo('input.mp4', 'safe_2.mp4', 'è¡›æ˜Ÿå½±ç‰‡');

                // 3. è™•ç†çµå°¾ç‰‡
                await processVideo('outro.mp4', 'safe_3.mp4', 'çµå°¾ç‰‡');

                // 4. åˆä½µ
                log("æ­¥é©Ÿ 4: æ­£åœ¨æ¥åˆå½±ç‰‡...");
                progressBar.innerText = "æœ€çµ‚åˆä½µä¸­...";
                
                // é€™æ¬¡çš„ concat å¾ˆç°¡å–®ï¼Œå› ç‚ºå‰é¢éƒ½å·²ç¶“æ¨™æº–åŒ–äº†
                await ffmpeg.run(
                    '-i', 'safe_1.mp4',
                    '-i', 'safe_2.mp4',
                    '-i', 'safe_3.mp4',
                    '-filter_complex', '[0:v][1:v][2:v]concat=n=3:v=1:a=0[v]',
                    '-map', '[v]',
                    '-c:v', 'libx264',
                    '-preset', 'ultrafast',
                    'output.mp4'
                );

                // 5. ä¸‹è¼‰
                log("âœ… åˆæˆæˆåŠŸï¼æ­£åœ¨ä¸‹è¼‰...");
                progressBar.style.width = '100%';
                progressBar.innerText = 'å®Œæˆï¼';
                
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const videoUrl = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                let saveName = document.getElementById('filename').value.trim() || 'SATORO_Shorts.mp4';
                if (!saveName.endsWith('.mp4')) saveName += '.mp4';

                const a = document.createElement('a');
                a.href = videoUrl;
                a.download = saveName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

            } catch (error) {
                console.error(error);
                log("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
                alert("åˆæˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒã€‚");
            }
            startBtn.disabled = false;
        });
    </script>
</body>
</html>
