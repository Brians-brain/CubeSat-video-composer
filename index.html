<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡›æ˜Ÿå½±ç‰‡åˆæˆå™¨ (Shortsç›´å¼ç‰ˆ)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #222; color: white; }
        h1 { text-align: center; color: #fff; }
        .container { background: #333; border-radius: 10px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; margin-top: 20px; }
        input[type="text"] { padding: 10px; width: 60%; font-size: 16px; border: 1px solid #555; border-radius: 5px; margin-top: 5px; background: #444; color: white; }
        input[type="file"] { margin-top: 10px; color: #ddd; }
        
        button { margin-top: 20px; padding: 12px 24px; font-size: 18px; cursor: pointer; background-color: #ff0050; color: white; border: none; border-radius: 25px; transition: transform 0.2s; font-weight: bold; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        button:hover:not(:disabled) { transform: scale(1.05); background-color: #ff3370; }
        
        /* é€²åº¦æ¢å®¹å™¨ */
        .progress-wrapper { width: 100%; background-color: #555; border-radius: 10px; margin-top: 15px; display: none; overflow: hidden; }
        #read-bar { width: 0%; height: 20px; background-color: #00bcd4; text-align: center; line-height: 20px; color: white; font-size: 12px; transition: width 0.2s; }
        #convert-bar { width: 0%; height: 20px; background-color: #4caf50; text-align: center; line-height: 20px; color: white; font-size: 12px; transition: width 0.2s; }
        
        #log { margin-top: 20px; font-family: monospace; color: #bbb; background: #111; padding: 10px; border-radius: 5px; text-align: left; max-height: 300px; overflow-y: auto; font-size: 12px; border: 1px solid #444; }
        .status-ok { color: #4caf50; font-weight: bold; }
        .status-err { color: #ff5252; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ“± YouTube Shorts åˆæˆå™¨ (1080x1350)</h1>
    <p style="text-align:center;">ç³»çµ±ç‹€æ…‹ï¼š<span id="system-status">æ­£åœ¨è¼‰å…¥å¼•æ“...</span></p>

    <div class="container">
        <h3>1. ä¸Šå‚³æ‚¨çš„è¡›æ˜Ÿå½±ç‰‡ (æ©«å¼å¯)</h3>
        <input type="file" id="upload-video" accept="video/mp4,video/mov">
        
        <br><br>
        
        <h3>2. è¨­å®šè¼¸å‡ºæª”å</h3>
        <input type="text" id="filename" value="Shorts_Video.mp4" placeholder="ä¾‹å¦‚ï¼šShorts_Mission.mp4">
        
        <br><br>
        
        <button id="start-btn" disabled>ğŸ¬ é–‹å§‹åˆæˆ Shorts</button>
        
        <div class="progress-wrapper" id="read-progress-container">
            <div id="read-bar">è®€å–ä¸­ 0%</div>
        </div>

        <div class="progress-wrapper" id="convert-progress-container">
            <div id="convert-bar">é‹ç®—ä¸­ 0%</div>
        </div>
        
        <div id="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        
        // â˜…â˜…â˜… è«‹ç¢ºèªæ‚¨çš„ GitHub Repo ç¶²å€æ­£ç¢º â˜…â˜…â˜…
        const BASE_ASSETS_URL = 'https://brians-brain.github.io/CubeSat-video-composer/assets/';

        const statusSpan = document.getElementById('system-status');
        const startBtn = document.getElementById('start-btn');
        const logDiv = document.getElementById('log');
        const readContainer = document.getElementById('read-progress-container');
        const readBar = document.getElementById('read-bar');
        const convertContainer = document.getElementById('convert-progress-container');
        const convertBar = document.getElementById('convert-bar');

        function log(message) {
            if(typeof message === 'string') {
                logDiv.innerHTML += `<div>> ${message}</div>`;
            } else {
                logDiv.innerHTML += `<div style="color:#ff5252">ERR: ${JSON.stringify(message)}</div>`;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        ffmpeg.setLogger(({ type, message }) => {
            // éæ¿¾æ‰å¤ªå¤šç„¡ç”¨çš„ FFmpeg è³‡è¨Šï¼Œåªç•™é—œéµ
            if(message.includes('Error') || message.includes('frame=')) {
                log(`[FFmpeg] ${message}`);
            }
        });

        (async () => {
            try {
                ffmpeg.setProgress(({ ratio }) => {
                    const percent = (ratio * 100).toFixed(1);
                    if(percent >= 0 && percent <= 100) {
                        convertBar.style.width = `${percent}%`;
                        convertBar.innerText = `åˆæˆé‹ç®—ä¸­: ${percent}%`;
                    }
                });

                await ffmpeg.load();
                statusSpan.innerHTML = "âœ… å¼•æ“æº–å‚™å°±ç·’";
                statusSpan.className = "status-ok";
                startBtn.disabled = false;
                log("ç³»çµ±å°±ç·’ï¼Œæº–å‚™è£½ä½œ Shortsã€‚");
            } catch (err) {
                statusSpan.innerHTML = "âŒ è¼‰å…¥å¤±æ•—";
                statusSpan.className = "status-err";
                log("éŒ¯èª¤ï¼š" + err.message);
            }
        })();

        function readFileWithProgress(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                readContainer.style.display = 'block';
                reader.onprogress = (data) => {
                    if (data.lengthComputable) {                                            
                        const progress = parseInt( ((data.loaded / data.total) * 100), 10 );
                        readBar.style.width = `${progress}%`;
                        readBar.innerText = `è®€å–æª”æ¡ˆä¸­: ${progress}%`;
                    }
                }
                reader.onload = () => resolve(new Uint8Array(reader.result));
                reader.onerror = () => reject(reader.error);
                reader.readAsArrayBuffer(file);
            });
        }

        startBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('upload-video');
            const filenameInput = document.getElementById('filename');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å€‹å½±ç‰‡æª”æ¡ˆï¼");
                return;
            }

            startBtn.disabled = true;
            startBtn.innerText = "â³ æ­£åœ¨è£½ä½œ Shorts...";
            convertContainer.style.display = 'block';
            convertBar.style.width = '0%';
            logDiv.innerHTML = "<div>--- é–‹å§‹æ–°ä»»å‹™ (ç›´å¼æ¨¡å¼) ---</div>";

            try {
                // 1. è®€å–æœ¬æ©Ÿæª”æ¡ˆ
                log(`æ­£åœ¨è®€å–: ${fileInput.files[0].name}`);
                const userFileBuffer = await readFileWithProgress(fileInput.files[0]);
                ffmpeg.FS('writeFile', 'input.mp4', userFileBuffer);
                
                // 2. æŠ“å–é ç«¯ç´ æ
                log("æ­£åœ¨ä¸‹è¼‰å‰å°èˆ‡çµå°¾å½±ç‰‡...");
                const timeStamp = new Date().getTime(); 
                try {
                    ffmpeg.FS('writeFile', 'intro.mp4', await fetchFile(BASE_ASSETS_URL + 'intro.mp4?t=' + timeStamp));
                    ffmpeg.FS('writeFile', 'outro.mp4', await fetchFile(BASE_ASSETS_URL + 'outro.mp4?t=' + timeStamp));
                } catch(e) {
                    throw new Error("ä¸‹è¼‰å¤±æ•—ï¼è«‹ç¢ºèª assets/intro.mp4 æ˜¯å¦å­˜åœ¨ã€‚");
                }

                // 3. åŸ·è¡Œåˆæˆ (é—œéµä¿®æ”¹ï¼šè§£æåº¦æ”¹ç‚º 1080:1350)
                log("ğŸš€ é–‹å§‹ FFmpeg é‹ç®— (ç›´å¼åˆæˆ)...");
                
                // æŒ‡ä»¤è§£æï¼š
                // scale=1080:1350:force_original_aspect_ratio=decrease -> æŠŠå½±ç‰‡ç¸®æ”¾åˆ°èƒ½å¡é€²ç›´å¼æ¡†æ¡†å…§
                // pad=1080:1350:(ow-iw)/2:(oh-ih)/2 -> å¦‚æœæœ‰ç•™ç™½ï¼Œç”¨é»‘é‚Šå¡«æ»¿ä¸¦ç½®ä¸­
                // setsar=1 -> ä¿®æ­£åƒç´ æ¯”ä¾‹é˜²æ­¢è®Šå½¢
                const scaleFilter = "scale=1080:1350:force_original_aspect_ratio=decrease,pad=1080:1350:(ow-iw)/2:(oh-ih)/2,setsar=1";
                
                await ffmpeg.run(
                    '-i', 'intro.mp4',
                    '-i', 'input.mp4',
                    '-i', 'outro.mp4',
                    '-filter_complex', 
                    `[0:v]${scaleFilter}[v0];[1:v]${scaleFilter}[v1];[2:v]${scaleFilter}[v2];[v0][v1][v2]concat=n=3:v=1:a=0[v]`,
                    '-map', '[v]',
                    '-c:v', 'libx264',
                    '-preset', 'ultrafast',
                    'output.mp4'
                );

                log("âœ… Shorts åˆæˆå®Œæˆï¼");
                convertBar.style.width = '100%';
                convertBar.innerText = 'å®Œæˆï¼';

                // 4. ä¸‹è¼‰
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const videoUrl = URL.createObjectURL(videoBlob);
                
                let saveName = filenameInput.value.trim() || 'Shorts_Video.mp4';
                if (!saveName.toLowerCase().endsWith('.mp4')) saveName += '.mp4';

                const a = document.createElement('a');
                a.href = videoUrl;
                a.download = saveName;
                document.body.appendChild(a);
                a.click();
                
                document.body.removeChild(a);

            } catch (error) {
                console.error(error);
                log("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
                alert("åˆæˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹æ—¥èªŒã€‚");
            }

            startBtn.disabled = false;
            startBtn.innerText = "ğŸ¬ é–‹å§‹åˆæˆ Shorts";
        });
    </script>
</body>
</html>
