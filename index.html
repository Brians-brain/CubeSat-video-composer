<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SATORO Shorts åˆæˆå™¨ (V8 å…©æ®µå¼å®‰å…¨ç‰ˆ)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #1a1a1a; color: #e0e0e0; }
        h1 { text-align: center; color: #ffffff; }
        .container { background: #2d2d2d; border-radius: 10px; padding: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); text-align: center; margin-top: 20px; }
        
        /* æª”æ¡ˆé¸æ“‡å€çš„ç¾åŒ– */
        .file-upload-wrapper { border: 2px dashed #555; padding: 20px; border-radius: 10px; margin-top: 10px; transition: border 0.3s; }
        .file-upload-wrapper:hover { border-color: #E1306C; }
        input[type="file"] { display: none; } /* éš±è—é†œé†œçš„åŸç”ŸæŒ‰éˆ• */
        .custom-file-upload { display: inline-block; padding: 10px 20px; cursor: pointer; background: #444; color: white; border-radius: 5px; border: 1px solid #666; }
        #file-name-display { margin-top: 10px; color: #4caf50; font-weight: bold; min-height: 20px; }

        input[type="text"] { padding: 10px; width: 70%; font-size: 16px; border: 1px solid #555; border-radius: 5px; margin-top: 5px; background: #404040; color: white; text-align: center; }
        
        button { margin-top: 25px; padding: 15px 30px; font-size: 20px; cursor: pointer; background-color: #E1306C; color: white; border: none; border-radius: 50px; transition: transform 0.2s; font-weight: bold; box-shadow: 0 4px 10px rgba(225, 48, 108, 0.3); }
        button:disabled { background-color: #555; cursor: not-allowed; box-shadow: none; }
        button:hover:not(:disabled) { transform: scale(1.05); background-color: #C13584; }
        
        /* é€²åº¦æ¢ */
        .progress-wrapper { width: 100%; background-color: #404040; border-radius: 10px; margin-top: 20px; display: none; overflow: hidden; height: 25px; }
        #progress-bar { width: 0%; height: 100%; background-color: #E1306C; text-align: center; line-height: 25px; color: white; font-size: 14px; transition: width 0.3s; font-weight: bold; }
        
        #log { margin-top: 20px; font-family: monospace; color: #ccc; background: #000; padding: 15px; border-radius: 5px; text-align: left; max-height: 250px; overflow-y: auto; font-size: 13px; border: 1px solid #444; }
    </style>
</head>
<body>
    <h1>ğŸ“± SATORO Shorts åˆæˆå™¨ (V8)</h1>
    <p style="text-align:center;">ç³»çµ±ç‹€æ…‹ï¼š<span id="system-status">æ­£åœ¨è¼‰å…¥å¼•æ“...</span></p>

    <div class="container">
        <h3>1. é¸æ“‡æ‚¨çš„è¡›æ˜Ÿå½±ç‰‡</h3>
        <div class="file-upload-wrapper">
            <label for="upload-video" class="custom-file-upload">ğŸ“‚ é»æ“Šé¸æ“‡å½±ç‰‡</label>
            <input type="file" id="upload-video" accept="video/mp4,video/mov">
            <div id="file-name-display">å°šæœªé¸æ“‡æª”æ¡ˆ</div>
        </div>
        
        <br>
        
        <h3>2. è¨­å®šè¼¸å‡ºæª”å</h3>
        <input type="text" id="filename" value="SATORO_Mission.mp4">
        
        <br>
        
        <button id="start-btn" disabled>ğŸš€ é–‹å§‹åˆæˆ Shorts</button>
        
        <div class="progress-wrapper" id="progress-container">
            <div id="progress-bar">æº–å‚™ä¸­...</div>
        </div>
        
        <div id="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        
        // â˜…â˜…â˜… è«‹ç¢ºèªæ‚¨çš„ GitHub Repo ç¶²å€æ­£ç¢º â˜…â˜…â˜…
        const BASE_ASSETS_URL = 'https://brians-brain.github.io/CubeSat-video-composer/assets/';

        const statusSpan = document.getElementById('system-status');
        const startBtn = document.getElementById('start-btn');
        const logDiv = document.getElementById('log');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const fileInput = document.getElementById('upload-video');
        const fileNameDisplay = document.getElementById('file-name-display');

        // é¡¯ç¤ºæª”æ¡ˆåç¨±ï¼Œè§£æ±ºã€Œä¸çŸ¥é“æœ‰æ²’æœ‰é¸åˆ°ã€çš„ç„¦æ…®
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.innerText = "âœ… å·²æº–å‚™å°±ç·’: " + fileInput.files[0].name;
                fileNameDisplay.style.color = "#4caf50";
            } else {
                fileNameDisplay.innerText = "å°šæœªé¸æ“‡æª”æ¡ˆ";
                fileNameDisplay.style.color = "#ccc";
            }
        });

        function log(message) {
            if(typeof message === 'string') {
                logDiv.innerHTML += `<div>> ${message}</div>`;
            } else {
                logDiv.innerHTML += `<div style="color:#ff5252">ERR: ${JSON.stringify(message)}</div>`;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        (async () => {
            try {
                ffmpeg.setProgress(({ ratio }) => {
                    const percent = (ratio * 100).toFixed(1);
                    if(percent >= 0 && percent <= 100) {
                        progressBar.style.width = `${percent}%`;
                        progressBar.innerText = `é‹ç®—ä¸­: ${percent}%`;
                    }
                });

                await ffmpeg.load();
                statusSpan.innerHTML = "âœ… å¼•æ“æº–å‚™å°±ç·’";
                statusSpan.style.color = "#4caf50";
                startBtn.disabled = false;
                log("ç³»çµ±å°±ç·’ï¼Œè«‹é¸æ“‡å½±ç‰‡å¾ŒæŒ‰ä¸‹é–‹å§‹ã€‚");
            } catch (err) {
                statusSpan.innerHTML = "âŒ è¼‰å…¥å¤±æ•— (è«‹æª¢æŸ¥ GitHub Pages ç’°å¢ƒ)";
                statusSpan.style.color = "#ff5252";
                log("éŒ¯èª¤ï¼š" + err.message);
            }
        })();

        startBtn.addEventListener('click', async () => {
            const filenameInput = document.getElementById('filename');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å€‹å½±ç‰‡æª”æ¡ˆï¼");
                return;
            }

            startBtn.disabled = true;
            startBtn.innerText = "â³ è™•ç†ä¸­ (å…©éšæ®µæ¨¡å¼)...";
            progressContainer.style.display = 'block';
            logDiv.innerHTML = "<div>--- é–‹å§‹æ–°ä»»å‹™ (V8) ---</div>";

            try {
                // 1. è®€å–æœ¬æ©Ÿæª”æ¡ˆ
                log(`Step 0: è®€å–æœ¬æ©Ÿå½±ç‰‡...`);
                const userFileBuffer = await fetchFile(fileInput.files[0]);
                ffmpeg.FS('writeFile', 'input.mp4', userFileBuffer);
                
                // 2. ä¸‹è¼‰ç´ æ
                const timeStamp = new Date().getTime(); 
                try {
                    ffmpeg.FS('writeFile', 'intro.mp4', await fetchFile(BASE_ASSETS_URL + 'intro.mp4?t=' + timeStamp));
                    ffmpeg.FS('writeFile', 'outro.mp4', await fetchFile(BASE_ASSETS_URL + 'outro.mp4?t=' + timeStamp));
                } catch(e) {
                    throw new Error("ç„¡æ³•ä¸‹è¼‰ç´ æï¼Œè«‹ç¢ºèªç¶²è·¯æˆ– GitHub æª”æ¡ˆã€‚");
                }

                // â˜…â˜…â˜… V8 æ ¸å¿ƒï¼šç¬¬ä¸€éšæ®µ - æ·¨åŒ–ä½¿ç”¨è€…å½±ç‰‡ â˜…â˜…â˜…
                log("Step 1/2: æ­£åœ¨æ¨™æº–åŒ–æ‚¨çš„è¡›æ˜Ÿå½±ç‰‡ (ç¸®æ”¾+è£œé»‘é‚Š)...");
                progressBar.innerText = "Step 1: æ ¼å¼åŒ–ä¸­...";
                
                // å…ˆæŠŠä½¿ç”¨è€…çš„å½±ç‰‡å–®ç¨è™•ç†æˆå®Œç¾çš„ 1080x1350
                // é€™æ¨£å¯ä»¥é¿å… concat å¤±æ•—
                await ffmpeg.run(
                    '-i', 'input.mp4',
                    '-vf', 'scale=1080:1350:force_original_aspect_ratio=decrease,pad=1080:1350:(1080-iw)/2:(1350-ih)/2,setsar=1,fps=30,format=yuv420p',
                    '-c:v', 'libx264',
                    '-preset', 'ultrafast',
                    'middle.mp4' // è¼¸å‡ºæˆæš«å­˜æª”
                );
                log("âœ… ç¬¬ä¸€éšæ®µå®Œæˆï¼Œè¡›æ˜Ÿå½±ç‰‡å·²æ¨™æº–åŒ–ã€‚");

                // â˜…â˜…â˜… V8 æ ¸å¿ƒï¼šç¬¬äºŒéšæ®µ - æ‹¼æ¥ â˜…â˜…â˜…
                log("Step 2/2: æ­£åœ¨åˆä½µå‰å°èˆ‡çµå°¾...");
                progressBar.innerText = "Step 2: åˆä½µä¸­...";

                // é€™æ¬¡åˆä½µéå¸¸å®‰å…¨ï¼Œå› ç‚º input å·²ç¶“æ˜¯æ¨™æº–æ ¼å¼äº†
                await ffmpeg.run(
                    '-i', 'intro.mp4',
                    '-i', 'middle.mp4',
                    '-i', 'outro.mp4',
                    '-filter_complex', '[0:v][1:v][2:v]concat=n=3:v=1:a=0[v]',
                    '-map', '[v]',
                    '-c:v', 'libx264', // ç‚ºäº†ä¿éšªèµ·è¦‹å†æ¬¡ç·¨ç¢¼ï¼Œç¢ºä¿ç›¸å®¹æ€§
                    '-preset', 'ultrafast',
                    'output.mp4'
                );

                log("âœ… å…¨éƒ¨å®Œæˆï¼æ­£åœ¨æ‰“åŒ…ä¸‹è¼‰...");
                progressBar.style.width = '100%';
                progressBar.innerText = 'å®Œæˆï¼';

                // 4. ä¸‹è¼‰
                try {
                    const data = ffmpeg.FS('readFile', 'output.mp4');
                    const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                    const videoUrl = URL.createObjectURL(videoBlob);
                    
                    let saveName = filenameInput.value.trim() || 'SATORO_Shorts.mp4';
                    if (!saveName.toLowerCase().endsWith('.mp4')) saveName += '.mp4';

                    const a = document.createElement('a');
                    a.href = videoUrl;
                    a.download = saveName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } catch (readErr) {
                    throw new Error("ç„¡æ³•è®€å–æª”æ¡ˆã€‚è«‹ç¢ºèª Step 2 æ˜¯å¦æœ‰ç´…è‰²éŒ¯èª¤è¨Šæ¯ã€‚");
                }

            } catch (error) {
                console.error(error);
                log("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
                alert("åˆæˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹æ—¥èªŒã€‚");
            }

            startBtn.disabled = false;
            startBtn.innerText = "ğŸš€ é–‹å§‹åˆæˆ Shorts";
        });
    </script>
</body>
</html>
