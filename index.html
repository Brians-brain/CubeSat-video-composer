<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡›æ˜Ÿè»Œé“å½±ç‰‡åˆæˆå™¨ (Proç‰ˆ)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        h1 { text-align: center; color: #333; }
        .container { background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; margin-top: 20px; }
        input[type="text"] { padding: 10px; width: 60%; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; margin-top: 5px; }
        input[type="file"] { margin-top: 10px; }
        button { margin-top: 20px; padding: 12px 24px; font-size: 18px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: background 0.3s; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #0056b3; }
        
        /* é€²åº¦æ¢å®¹å™¨ */
        .progress-wrapper { width: 100%; background-color: #eee; border-radius: 10px; margin-top: 15px; display: none; overflow: hidden; }
        /* å…©å€‹é€²åº¦æ¢ï¼šä¸€å€‹æ˜¯è®€å–(è—)ï¼Œä¸€å€‹æ˜¯é‹ç®—(ç¶ ) */
        #read-bar { width: 0%; height: 20px; background-color: #17a2b8; text-align: center; line-height: 20px; color: white; font-size: 12px; transition: width 0.2s; }
        #convert-bar { width: 0%; height: 20px; background-color: #28a745; text-align: center; line-height: 20px; color: white; font-size: 12px; transition: width 0.2s; }
        
        #log { margin-top: 20px; font-family: monospace; color: #555; background: #eee; padding: 10px; border-radius: 5px; text-align: left; max-height: 200px; overflow-y: auto; font-size: 12px; }
        .status-ok { color: green; font-weight: bold; }
        .status-err { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ›°ï¸ è¡›æ˜Ÿè»Œé“å½±ç‰‡åˆæˆå™¨ (Proç‰ˆ)</h1>
    <p style="text-align:center;">ç³»çµ±ç‹€æ…‹ï¼š<span id="system-status">æ­£åœ¨è¼‰å…¥å¼•æ“...</span></p>

    <div class="container">
        <h3>1. ä¸Šå‚³æ‚¨çš„è¡›æ˜Ÿå½±ç‰‡</h3>
        <input type="file" id="upload-video" accept="video/mp4,video/mov">
        
        <br><br>
        
        <h3>2. è¨­å®šè¼¸å‡ºæª”å</h3>
        <input type="text" id="filename" value="merged_video.mp4" placeholder="ä¾‹å¦‚ï¼šMission_Alpha.mp4">
        
        <br><br>
        
        <button id="start-btn" disabled>ğŸš€ é–‹å§‹åˆæˆå½±ç‰‡</button>
        
        <div class="progress-wrapper" id="read-progress-container">
            <div id="read-bar">è®€å–ä¸­ 0%</div>
        </div>

        <div class="progress-wrapper" id="convert-progress-container">
            <div id="convert-bar">é‹ç®—ä¸­ 0%</div>
        </div>
        
        <div id="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: false });
        
        // â˜…â˜…â˜… è¨­å®šçµ•å°è·¯å¾‘åŸºåº• (è«‹ç¢ºä¿æ‚¨çš„ repo åç¨±æ­£ç¢º) â˜…â˜…â˜…
        const BASE_ASSETS_URL = 'https://brians-brain.github.io/CubeSat-video-composer/assets/';

        const statusSpan = document.getElementById('system-status');
        const startBtn = document.getElementById('start-btn');
        const logDiv = document.getElementById('log');
        
        // é€²åº¦æ¢å…ƒä»¶
        const readContainer = document.getElementById('read-progress-container');
        const readBar = document.getElementById('read-bar');
        const convertContainer = document.getElementById('convert-progress-container');
        const convertBar = document.getElementById('convert-bar');

        function log(message) {
            logDiv.innerHTML += `<div>> ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        (async () => {
            try {
                ffmpeg.setProgress(({ ratio }) => {
                    const percent = (ratio * 100).toFixed(1);
                    if(percent >= 0 && percent <= 100) {
                        convertBar.style.width = `${percent}%`;
                        convertBar.innerText = `åˆæˆé‹ç®—ä¸­: ${percent}%`;
                    }
                });

                await ffmpeg.load();
                statusSpan.innerHTML = "âœ… å¼•æ“æº–å‚™å°±ç·’ (System Ready)";
                statusSpan.className = "status-ok";
                startBtn.disabled = false;
                log("ç³»çµ±å°±ç·’ï¼Œè«‹ä¸Šå‚³å½±ç‰‡ã€‚");
            } catch (err) {
                statusSpan.innerHTML = "âŒ è¼‰å…¥å¤±æ•— (GitHub Pages æ¬Šé™éŒ¯èª¤)";
                statusSpan.className = "status-err";
                log("éŒ¯èª¤ï¼š" + err.message);
            }
        })();

        // è¼”åŠ©å‡½å¼ï¼šç”¨ FileReader è®€å–æª”æ¡ˆä¸¦é¡¯ç¤ºé€²åº¦
        function readFileWithProgress(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                readContainer.style.display = 'block'; // é¡¯ç¤ºè®€å–æ¢
                
                reader.onprogress = (data) => {
                    if (data.lengthComputable) {                                            
                        const progress = parseInt( ((data.loaded / data.total) * 100), 10 );
                        readBar.style.width = `${progress}%`;
                        readBar.innerText = `è®€å–æª”æ¡ˆä¸­: ${progress}%`;
                    }
                }
                
                reader.onload = () => resolve(new Uint8Array(reader.result));
                reader.onerror = () => reject(reader.error);
                
                reader.readAsArrayBuffer(file);
            });
        }

        startBtn.addEventListener('click', async () => {
            const fileInput = document.getElementById('upload-video');
            const filenameInput = document.getElementById('filename');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å€‹å½±ç‰‡æª”æ¡ˆï¼");
                return;
            }

            startBtn.disabled = true;
            startBtn.innerText = "â³ è™•ç†ä¸­...";
            convertContainer.style.display = 'block';
            convertBar.style.width = '0%';
            log("--- é–‹å§‹è™•ç†ä»»å‹™ ---");

            try {
                // 1. è®€å–æœ¬æ©Ÿæª”æ¡ˆ (é¡¯ç¤ºè—è‰²é€²åº¦æ¢)
                log(`æ­£åœ¨è®€å–æ‚¨çš„å½±ç‰‡: ${fileInput.files[0].name}...`);
                const userFileBuffer = await readFileWithProgress(fileInput.files[0]);
                ffmpeg.FS('writeFile', 'input.mp4', userFileBuffer);
                log("âœ… å½±ç‰‡è®€å–å®Œæˆï¼");

                // 2. æŠ“å–é ç«¯ç´ æ (ä½¿ç”¨çµ•å°è·¯å¾‘)
                log("æ­£åœ¨å¾ GitHub ä¸‹è¼‰å‰å°èˆ‡çµå°¾å½±ç‰‡...");
                try {
                    // å¼·åˆ¶åŠ ä¸Šæ™‚é–“æˆ³è¨˜ (?t=...) é¿å…ç€è¦½å™¨æŠ“åˆ°èˆŠçš„ 404 å¿«å–
                    const timeStamp = new Date().getTime(); 
                    ffmpeg.FS('writeFile', 'intro.mp4', await fetchFile(BASE_ASSETS_URL + 'intro.mp4?t=' + timeStamp));
                    ffmpeg.FS('writeFile', 'outro.mp4', await fetchFile(BASE_ASSETS_URL + 'outro.mp4?t=' + timeStamp));
                } catch (e) {
                    throw new Error("ç„¡æ³•ä¸‹è¼‰å‰å°ç‰‡/çµå°¾ç‰‡ï¼è«‹ç¢ºèª GitHub é€£çµæ˜¯å¦æœ‰æ•ˆ (404éŒ¯èª¤)ã€‚");
                }

                // 3. åŸ·è¡Œåˆæˆ
                log("é–‹å§‹ FFmpeg é‹ç®— (è«‹å‹¿é—œé–‰è¦–çª—)...");
                await ffmpeg.run(
                    '-i', 'intro.mp4',
                    '-i', 'input.mp4',
                    '-i', 'outro.mp4',
                    '-filter_complex', 
                    '[0:v]scale=1920:1080[v0];[1:v]scale=1920:1080[v1];[2:v]scale=1920:1080[v2];[v0][v1][v2]concat=n=3:v=1:a=0[v]',
                    '-map', '[v]',
                    'output.mp4'
                );

                log("âœ… åˆæˆå®Œæˆï¼æ­£åœ¨æ‰“åŒ…...");
                convertBar.style.width = '100%';
                convertBar.innerText = 'å®Œæˆï¼';

                // 4. ä¸‹è¼‰
                const data = ffmpeg.FS('readFile', 'output.mp4');
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const videoUrl = URL.createObjectURL(videoBlob);
                
                let saveName = filenameInput.value.trim() || 'merged_video.mp4';
                if (!saveName.toLowerCase().endsWith('.mp4')) saveName += '.mp4';

                const a = document.createElement('a');
                a.href = videoUrl;
                a.download = saveName;
                document.body.appendChild(a);
                a.click();
                
                log(`å·²å•Ÿå‹•ä¸‹è¼‰ï¼š${saveName}`);
                document.body.removeChild(a);

            } catch (error) {
                console.error(error);
                log("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
                alert("éŒ¯èª¤ï¼š" + error.message);
            }

            // é‡ç½®æŒ‰éˆ•
            startBtn.disabled = false;
            startBtn.innerText = "ğŸš€ é–‹å§‹åˆæˆå½±ç‰‡";
        });
    </script>
</body>
</html>
