<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SATORO Shorts åˆæˆå™¨ (V9 çµ‚æ¥µç©©å®šç‰ˆ)</title>
    <script src="coi-serviceworker.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.0/dist/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #121212; color: #e0e0e0; }
        h1 { text-align: center; color: #ffffff; letter-spacing: 1px; }
        .container { background: #1e1e1e; border-radius: 12px; padding: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.6); text-align: center; margin-top: 20px; border: 1px solid #333; }
        
        .file-upload-wrapper { border: 2px dashed #444; padding: 25px; border-radius: 10px; margin-top: 10px; transition: all 0.3s; background: #252525; }
        .file-upload-wrapper:hover { border-color: #E1306C; background: #2a2a2a; }
        input[type="file"] { display: none; }
        .custom-file-upload { display: inline-block; padding: 12px 25px; cursor: pointer; background: linear-gradient(45deg, #E1306C, #C13584); color: white; border-radius: 30px; border: none; font-weight: bold; box-shadow: 0 4px 10px rgba(225, 48, 108, 0.4); }
        #file-name-display { margin-top: 15px; color: #888; font-size: 14px; min-height: 20px; word-break: break-all; }

        input[type="text"] { padding: 12px; width: 80%; font-size: 16px; border: 1px solid #444; border-radius: 8px; margin-top: 5px; background: #2d2d2d; color: white; text-align: center; }
        
        button { margin-top: 30px; padding: 15px 40px; font-size: 20px; cursor: pointer; background-color: #009688; color: white; border: none; border-radius: 50px; transition: transform 0.2s, background 0.2s; font-weight: bold; box-shadow: 0 4px 15px rgba(0, 150, 136, 0.4); }
        button:disabled { background-color: #555; cursor: not-allowed; box-shadow: none; transform: none; }
        button:hover:not(:disabled) { transform: scale(1.05); background-color: #00796b; }
        
        .progress-wrapper { width: 100%; background-color: #333; border-radius: 10px; margin-top: 25px; display: none; overflow: hidden; height: 28px; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #E1306C, #F77737); text-align: center; line-height: 28px; color: white; font-size: 14px; transition: width 0.3s; font-weight: bold; }
        
        #log { margin-top: 25px; font-family: 'Consolas', monospace; color: #bbb; background: #000; padding: 15px; border-radius: 8px; text-align: left; max-height: 300px; overflow-y: auto; font-size: 13px; border: 1px solid #333; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ“± SATORO Shorts åˆæˆå™¨ (V9)</h1>
    <p style="text-align:center; font-size: 14px; color: #888;">ç³»çµ±ç‹€æ…‹ï¼š<span id="system-status">æ­£åœ¨è¼‰å…¥å¼•æ“...</span></p>

    <div class="container">
        <h3 style="margin-bottom: 5px;">1. é¸æ“‡æ‚¨çš„è¡›æ˜Ÿå½±ç‰‡</h3>
        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">(æ”¯æ´ç›´å¼/æ©«å¼/480x640 ç­‰å„ç¨®æ ¼å¼)</p>
        
        <div class="file-upload-wrapper">
            <label for="upload-video" class="custom-file-upload">ğŸ“‚ é»æ“Šé¸æ“‡å½±ç‰‡æª”æ¡ˆ</label>
            <input type="file" id="upload-video" accept="video/mp4,video/mov">
            <div id="file-name-display">å°šæœªé¸æ“‡æª”æ¡ˆ (è«‹é»æ“Šä¸Šæ–¹æŒ‰éˆ•)</div>
        </div>
        
        <br>
        
        <h3>2. è¨­å®šè¼¸å‡ºæª”å</h3>
        <input type="text" id="filename" value="SATORO_Mission.mp4">
        
        <br>
        
        <button id="start-btn" disabled>ğŸš€ é–‹å§‹åˆæˆ Shorts</button>
        
        <div class="progress-wrapper" id="progress-container">
            <div id="progress-bar">æº–å‚™ä¸­...</div>
        </div>
        
        <div id="log">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        const ffmpeg = createFFmpeg({ log: true });
        
        // â˜…â˜…â˜… ç¢ºèªæ‚¨çš„ GitHub URL â˜…â˜…â˜…
        const BASE_ASSETS_URL = 'https://brians-brain.github.io/CubeSat-video-composer/assets/';

        const statusSpan = document.getElementById('system-status');
        const startBtn = document.getElementById('start-btn');
        const logDiv = document.getElementById('log');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        const fileInput = document.getElementById('upload-video');
        const fileNameDisplay = document.getElementById('file-name-display');

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.innerText = "âœ… å·²æº–å‚™å°±ç·’: " + fileInput.files[0].name;
                fileNameDisplay.style.color = "#4caf50";
                fileNameDisplay.style.fontWeight = "bold";
            } else {
                fileNameDisplay.innerText = "å°šæœªé¸æ“‡æª”æ¡ˆ";
                fileNameDisplay.style.color = "#888";
                fileNameDisplay.style.fontWeight = "normal";
            }
        });

        function log(message) {
            if(typeof message === 'string') {
                logDiv.innerHTML += `<div>> ${message}</div>`;
            } else {
                logDiv.innerHTML += `<div style="color:#ff5252">ERR: ${JSON.stringify(message)}</div>`;
            }
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        (async () => {
            try {
                ffmpeg.setProgress(({ ratio }) => {
                    const percent = (ratio * 100).toFixed(1);
                    if(percent >= 0 && percent <= 100) {
                        progressBar.style.width = `${percent}%`;
                        progressBar.innerText = `é‹ç®—ä¸­: ${percent}%`;
                    }
                });

                await ffmpeg.load();
                statusSpan.innerHTML = "âœ… å¼•æ“æº–å‚™å°±ç·’";
                statusSpan.style.color = "#4caf50";
                startBtn.disabled = false;
                log("ç³»çµ±å°±ç·’ï¼Œè«‹é¸æ“‡å½±ç‰‡ã€‚");
            } catch (err) {
                statusSpan.innerHTML = "âŒ è¼‰å…¥å¤±æ•— (è«‹ç¢ºèª coi-serviceworker æ˜¯å¦é‹ä½œ)";
                statusSpan.style.color = "#ff5252";
                log("éŒ¯èª¤ï¼š" + err.message);
            }
        })();

        startBtn.addEventListener('click', async () => {
            const filenameInput = document.getElementById('filename');
            
            if (fileInput.files.length === 0) {
                alert("è«‹å…ˆé¸æ“‡ä¸€å€‹å½±ç‰‡æª”æ¡ˆï¼");
                return;
            }

            startBtn.disabled = true;
            startBtn.innerText = "â³ å…¨é€Ÿé‹ç®—ä¸­...";
            progressContainer.style.display = 'block';
            logDiv.innerHTML = "<div>--- é–‹å§‹ä»»å‹™ (V9 å…¨é¢æ¨™æº–åŒ–) ---</div>";

            try {
                // 1. è®€å–èˆ‡ä¸‹è¼‰
                log(`[1/3] æ­£åœ¨è®€å–å½±ç‰‡èˆ‡ç´ æ...`);
                progressBar.innerText = "è®€å–ç´ æä¸­...";
                
                ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(fileInput.files[0]));
                
                const timeStamp = new Date().getTime(); 
                try {
                    ffmpeg.FS('writeFile', 'intro.mp4', await fetchFile(BASE_ASSETS_URL + 'intro.mp4?t=' + timeStamp));
                    ffmpeg.FS('writeFile', 'outro.mp4', await fetchFile(BASE_ASSETS_URL + 'outro.mp4?t=' + timeStamp));
                } catch(e) {
                    throw new Error("ç´ æä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ assets/intro.mp4 æ˜¯å¦å­˜åœ¨ã€‚");
                }

                // 2. åŸ·è¡Œ FFmpeg (ä½¿ç”¨æœ€å¼·åŠ›çš„æ¿¾é¡éˆ)
                log(`[2/3] é–‹å§‹åˆæˆ (é€™å¯èƒ½éœ€è¦ 30-60 ç§’)...`);
                progressBar.innerText = "å½±åƒåˆæˆä¸­...";
                
                // V9 æ ¸å¿ƒé‚è¼¯ï¼š
                // ä¸ç®¡æ˜¯ [0:v]å‰å°, [1:v]è¡›æ˜Ÿ, [2:v]çµå°¾
                // å…¨éƒ¨éƒ½å¥—ç”¨åŒä¸€å¥— filterï¼šç¸®æ”¾è‡³ 1080x1350 + è£œé»‘é‚Š + å¼·åˆ¶ SAR=1 + å¼·åˆ¶ 30fps + å¼·åˆ¶ YUV420P
                // é€™æ¨£å¯ä»¥ä¿è­‰ concat çµ•å°ä¸æœƒå¤±æ•—
                const normalizeFilter = "scale=1080:1350:force_original_aspect_ratio=decrease,pad=1080:1350:(ow-iw)/2:(oh-ih)/2,setsar=1,fps=30,format=yuv420p";
                
                await ffmpeg.run(
                    '-i', 'intro.mp4',
                    '-i', 'input.mp4',
                    '-i', 'outro.mp4',
                    '-filter_complex', 
                    `[0:v]${normalizeFilter}[v0];[1:v]${normalizeFilter}[v1];[2:v]${normalizeFilter}[v2];[v0][v1][v2]concat=n=3:v=1:a=0[v]`,
                    '-map', '[v]',
                    '-c:v', 'libx264',
                    '-preset', 'ultrafast', // é€Ÿåº¦å„ªå…ˆ
                    'output.mp4'
                );

                log(`[3/3] åˆæˆå®Œæˆï¼æª¢æŸ¥æª”æ¡ˆ...`);
                progressBar.innerText = "æ‰“åŒ…ä¸‹è¼‰ä¸­...";

                // 3. æª”æ¡ˆæª¢æŸ¥èˆ‡ä¸‹è¼‰
                // åˆ—å‡ºç›®éŒ„ä¸‹çš„æª”æ¡ˆï¼Œæ–¹ä¾¿é™¤éŒ¯
                const files = ffmpeg.FS('readdir', '/');
                log(`ç£ç¢Ÿç‹€æ…‹: ${files.join(', ')}`);

                if (!files.includes('output.mp4')) {
                    throw new Error("output.mp4 æœªç”Ÿæˆï¼è«‹æŸ¥çœ‹ä¸Šæ–¹æ—¥èªŒæ˜¯å¦æœ‰ç´…å­—éŒ¯èª¤ã€‚");
                }

                const data = ffmpeg.FS('readFile', 'output.mp4');
                const videoBlob = new Blob([data.buffer], { type: 'video/mp4' });
                const videoUrl = URL.createObjectURL(videoBlob);
                
                let saveName = filenameInput.value.trim() || 'SATORO_Shorts.mp4';
                if (!saveName.toLowerCase().endsWith('.mp4')) saveName += '.mp4';

                const a = document.createElement('a');
                a.href = videoUrl;
                a.download = saveName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                log("âœ… æˆåŠŸï¼æª”æ¡ˆæ‡‰å·²é–‹å§‹ä¸‹è¼‰ã€‚");
                progressBar.style.width = '100%';
                progressBar.innerText = 'å®Œæˆï¼';

            } catch (error) {
                console.error(error);
                log("âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š" + error.message);
                alert("åˆæˆå¤±æ•—ï¼è«‹æˆªåœ–ä¸‹æ–¹çš„é»‘è‰²æ—¥èªŒå€çµ¦æˆ‘ã€‚");
            }

            startBtn.disabled = false;
            startBtn.innerText = "ğŸš€ é–‹å§‹åˆæˆ Shorts";
        });
    </script>
</body>
</html>
